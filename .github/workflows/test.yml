name: Ada quick tests

# Bump
on: push

jobs:
  bump:
    name: Bump version
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/provision-with-micromamba@main # https://github.com/mamba-org/provision-with-micromamba
        with:
          cache-env: true
          environment-name: ada
          channels: conda-forge
          channel-priority: strict
          extra-specs: |
            python=3.11
            requests
      - name: Bump version
        id: bump
        run: python bump.py
        working-directory: .github/workflows
      - name: echo bump
        run: |
          echo ${{ steps.bump.outputs.version }}
  test-core:
    name: Quick Test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/provision-with-micromamba@main # https://github.com/mamba-org/provision-with-micromamba
        with:
          cache-env: true
          environment-name: ada
          channels: conda-forge
          channel-priority: strict
          environment-file: environment.dev.yml
          extra-specs: |
            python=3.11
            requests

      - name: Just Build & Test
        run: pytest ./tests --ignore=./tests/docker/ --ignore=./tests/full/

  test-full:
    name: Quick Test
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}
    outputs:
      version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/provision-with-micromamba@main # https://github.com/mamba-org/provision-with-micromamba
        with:
          cache-env: true
          environment-name: ada
          channels: conda-forge
          channel-priority: strict
          environment-file: environment.dev.yml
          extra-specs: |
            python=3.11
            ada-py=*=full*

      - name: Just Build & Test
        run: pytest ./tests --ignore=./tests/docker/

  upload:
    needs: test-core & test-full & bump
    name: Publish to CONDA
    defaults:
      run:
        shell: bash -l {0}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        build: [ { name: 'core' },{ name: 'full' } ]
    steps:
      - uses: actions/checkout@v3
      - uses: mamba-org/provision-with-micromamba@main # https://github.com/mamba-org/provision-with-micromamba
        with:
          cache-env: true
          environment-name: ada
          channels: conda-forge
          channel-priority: strict
          environment-file: conda/environment.build.yml

      - name: Echo version
        run: |
          echo ${{ needs.bump.outputs.version }}

      - name: Build & Upload to CONDA Dev
        if: ${{ contains(github.event.head_commit.message, '[dev]') }}
        run: |
          conda mambabuild -c conda-forge -c krande/label/dev . --variants "{'variant': '${{matrix.build.name}}'}" --user krande --label dev --token=${{ secrets.ANACONDA_TOKEN }}
        working-directory: conda
        env:
          VERSION: ${{ needs.bump.outputs.version }}